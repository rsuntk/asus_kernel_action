name: Build Kernel
on:
  workflow_dispatch:
    inputs:
      REPO:
        description: 'Kernel repository'
        default: 'rsuplaygrnd/android_kernel_asus_sdm660-4.19'
        required: true
      BRANCH:
        description: 'Kernel branch'
        default: 'master'
        required: true
      DEVICE_TARGET:
        description: 'Device to build'
        default: 'X01BD'
        type: choice
        options: [X01BD, X00TD]
      KSU:
        description: 'Add KernelSU support'
        type: boolean
        default: false
      APPLY_WORKAROUND:
        description: 'Disable Thermal Configs'
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Set Timezone
      run: sudo ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime

    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Clone kernel source
      run: git clone --depth=1 --single-branch -b ${{ github.event.inputs.BRANCH }} https://github.com/${{ github.event.inputs.REPO }} kernel_root

    # Caching Toolchain (Saves ~1-2 min)
    - name: Cache Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: $HOME/gcc-14.2.0-nolibc
        key: gcc-14.2.0-nolibc-aarch64

    # Caching CCACHE (Saves ~10-15 min on repeat builds)
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-kernel-${{ github.event.inputs.DEVICE_TARGET }}-${{ github.sha }}
        restore-keys: ccache-kernel-${{ github.event.inputs.DEVICE_TARGET }}-

    - name: Prepare Dependencies
      run: chmod +x ./build.sh && bash ./build.sh --setup-deps

    - name: Setup Build Environment
      id: buildKernel
      run: |
        cd kernel_root
        gitsha1=$(git rev-parse --short HEAD)
        echo "buildDetails=$(make kernelversion)-${{ github.event.inputs.DEVICE_TARGET }}_$gitsha1" >> $GITHUB_OUTPUT

    - name: Fetch Toolchains
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        chmod +x build.sh
        bash ./build.sh --fetch-toolchains

    - name: Build Kernel
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        DEVICE_TARGET: ${{ github.event.inputs.DEVICE_TARGET }}
        USE_PERSONAL_DEFCONFIG: ${{ github.event.inputs.USE_PERSONAL }}
        APPLY_WORKAROUND: ${{ github.event.inputs.APPLY_WORKAROUND }}
        KSU: ${{ github.event.inputs.KSU }}
      run: |
        cd kernel_root
        # Handle KernelSU
        if [[ "$KSU" == "true" ]]; then
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
        fi
        bash ../build.sh

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ steps.buildKernel.outputs.buildDetails }}
        path: |
          kernel_root/out/arch/arm64/boot/Image.gz-dtb
          kernel_root/*.zip
          kernel_root/out/.config
